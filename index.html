<!doctype html>
<html>
<head>
<title>Example Koenvajs</title>

<meta charset="utf-8" />
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style type="text/css">
body {
background-color: #fdfdff;
margin: 0;
padding: 0;
font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;        
}
  
main {
width: 600px;
margin: 5em auto;
padding: 2em;
background-color: #fdfdff;
}
  
a:link, a:visited {
color: #38488f;
text-decoration: none;

#stage-container {
width: 300px;
height: 300px;
}
  
label {
display: block;
}

input, button, select, textarea {
font-family: inherit;
font-size: inherit;
padding: 0.4em;
margin: 0 0 0.5em 0;
box-sizing: border-box;
border: 1px solid #ccc;
border-radius: 2px;
max-width: 100%;
}

input:disabled {
color: #ccc;
}

input[type="range"] {
height: 0;
}

button {
color: #333;
background-color: #f4f4f4;
outline: none;
}

button:disabled {
color: #999;
}

button:not(:disabled):active {
background-color: #ddd;
}

button:focus {
border-color: #666;
}

@media (max-width: 700px) {
main {
margin: 0 auto;
width: auto;
}
}
</style>    
<script src="https://cdn.jsdelivr.net/npm/konva@7.2.3/konva.min.js"></script>
</head>

<body>
<main>
<h1>Example KonvaJs</h1>
<p><input type="file" id="imageInput" accept="image/*"></p>
<p>
<div id="stage-container" style="width:300px"></div>
</p>

<p>
<button id="save">Save as image</button>
</p>
</main>
<script>
// Initialize Konva  
  
const stage = new Konva.Stage({
container: 'stage-container',
width: 300,
height: 300,
});

// Create a layer for the images
const imageLayer = new Konva.Layer();

stage.add(imageLayer);

// Function to handle image upload
document.getElementById('imageInput').addEventListener('change', function (event) {
const file = event.target.files[0];

if (file) {
const reader = new FileReader();

reader.onload = function () {
const img = new Image();
img.src = reader.result;

img.onload = function () {
// Create a Konva image for the user-uploaded image
const userImage = new Konva.Image({
image: img,
width: stage.width(),
height: stage.height(),
});

// Load the "https://placehold.co" image
const placeholderImg = new Image();
placeholderImg.src = 'twibbon.png';

placeholderImg.onload = () => {
// Create a Konva image for the "https://placehold.co" image
const placeholderImage = new Konva.Image({
image: placeholderImg,
width: stage.width(),
height: 300,
});

// Add the user image and the placeholder image to the stage
imageLayer.removeChildren();
imageLayer.add(userImage);
imageLayer.add(placeholderImage);
imageLayer.draw();
};
};
};

reader.readAsDataURL(file);
}
});

// background canvas
// stage.container().style.backgroundColor = 'gray';

// function from https://stackoverflow.com/a/15832662/512042
function downloadURI(uri, name) {
var link = document.createElement('a');
link.download = name;
link.href = uri;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
delete link;
}

document.getElementById('save').addEventListener(
'click',
function () {
var dataURL = stage.toDataURL({ pixelRatio: 3 });
downloadURI(dataURL, 'stage.png');
},
false
);
</script>
</body>
</html>
